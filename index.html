<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>R'lyeh / ルルイエ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:radial-gradient(circle,#020403 0%,#000 75%);
  color:#b9c2b0;
  font-family:"Yu Mincho",serif;
  text-shadow:0 0 2px rgba(120,150,120,.2);
  overflow:hidden;
}
header{
  padding:18px;
  text-align:center;
  border-bottom:1px solid #133;
}
header h1{
  letter-spacing:.25em;
  font-weight:normal;
  color:#7aa69d;
  text-shadow:
    0 0 5px rgba(50,120,100,.5),
    0 0 18px rgba(0,40,30,.8);
}
#board{
  height:520px;
  overflow-y:auto;
  margin:30px;
  padding:12px;
  background:rgba(0,0,0,.55);
  border:1px solid #233;
  box-shadow:
    inset 0 0 35px rgba(0,0,0,.9),
    0 0 20px rgba(0,80,60,.2);
  backdrop-filter:blur(1px);
}
.post{
  border-bottom:1px dashed #244;
  padding:12px 0;
}
.post div{
  animation:textGlitch .15s steps(2) infinite;
  animation-play-state:paused;
}
#form{
  max-width:800px;
  margin:20px auto;
  padding:16px;
  border:1px solid #133;
}
textarea{
  width:100%;
  height:80px;
  background:#000;
  color:#cfd8c3;
  border:1px solid #244;
}
button{
  margin-top:8px;
  background:#021;
  color:#cfd8c3;
  border:1px solid #355;
  padding:6px 12px;
}

/* ノイズ & CRT */
.noise{
  position:fixed;
  inset:0;
  pointer-events:none;
  opacity:.05;
  background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4"/></filter><rect width="200" height="200" filter="url(%23n)"/></svg>');
}
.crt{
  position:fixed;
  inset:0;
  pointer-events:none;
  background:repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,.03) 0px,
    rgba(0,0,0,.06) 2px,
    rgba(0,0,0,0) 4px
  );
  mix-blend-mode:overlay;
  opacity:0;
}
.crt.active{opacity:1}

/* 異常 */
@keyframes screenShake{
  0%{transform:translate(0)}
  25%{transform:translate(2px,-2px)}
  50%{transform:translate(-2px,2px)}
  75%{transform:translate(2px,2px)}
  100%{transform:translate(0)}
}
@keyframes textGlitch{
  0%{text-shadow:1px 0 red,-1px 0 cyan}
  50%{text-shadow:-2px 0 red,2px 0 cyan}
  100%{text-shadow:none}
}
body.anomaly-full{
  animation:screenShake .08s infinite;
  filter:contrast(220%) saturate(180%) blur(.6px) hue-rotate(-10deg);
}
body.anomaly-full .post div{
  animation-play-state:running;
}
body.anomaly-full::before{
  content:'';
  position:fixed;
  inset:0;
  background:rgba(180,0,0,.6);
  z-index:9998;
}
body.anomaly-full::after{
  content:'';
  position:fixed;
  inset:0;
  background:repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,.05) 0px,
    rgba(255,255,255,.05) 1px,
    rgba(0,0,0,0) 2px,
    rgba(0,0,0,0) 4px
  );
  z-index:9999;
}

/* 監視 */
body::after{
  content:"● REC";
  position:fixed;
  bottom:10px;
  right:14px;
  font-size:11px;
  color:rgba(200,0,0,.6);
  animation:blink 1.2s infinite;
}
@keyframes blink{
  0%,50%{opacity:1}
  51%,100%{opacity:0}
}
body:hover{cursor:none}
</style>
</head>

<body>

<header>
  <h1>R'lyeh / ルルイエ</h1>
  <div style="font-size:12px;opacity:.7">※ この掲示板に書き込んだ者は記録される</div>
</header>

<div id="board"></div>

<div id="form">
  <div>書き込み：</div>
  <textarea id="input"></textarea>
  <button onclick="sendPost()">送信</button>
</div>

<div class="noise"></div>
<div class="crt" id="crt"></div>

<script>
/* ===== 右クリック・キー操作禁止 ===== */
document.addEventListener('contextmenu',e=>e.preventDefault());
document.addEventListener('keydown',e=>{
  if(
    e.key==="F12" ||
    (e.ctrlKey && e.shiftKey && ["I","J","C"].includes(e.key)) ||
    (e.ctrlKey && e.key==="U")
  ){
    e.preventDefault();
  }
});

/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyC1IK8k7yfu7rEzGBsQHl9CLHLy1aCwYTE",
  authDomain:"rlyeh-board.firebaseapp.com",
  databaseURL:"https://rlyeh-board-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"rlyeh-board"
});
const db=firebase.database();
const postsRef=db.ref('posts');
const board=document.getElementById('board');
const crt=document.getElementById('crt');

/* 投稿追加（時刻なし） */
function addPost(text){
  const d=document.createElement('div');
  d.className='post';
  d.innerHTML=`<div>${text}</div>`;
  board.prepend(d);
}

postsRef.limitToLast(30).on('child_added',s=>{
  const d=s.val();
  addPost(d.text);
});

function sendPost(){
  const i=document.getElementById('input');
  if(!i.value.trim())return;
  postsRef.push({text:i.value});
  i.value='';
}

/* 深海音 */
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
document.body.addEventListener('click',()=>{
  if(audioCtx.state!=="running"){
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.frequency.value=40;
    g.gain.value=.05;
    o.connect(g).connect(audioCtx.destination);
    o.start();
  }
},{once:true});

/* 異常イベント */
function anomaly(){
  if(Math.random()>0.6)return;
  document.body.classList.add('anomaly-full');
  crt.classList.add('active');
  setTimeout(()=>{
    document.body.classList.remove('anomaly-full');
    crt.classList.remove('active');
  },8000+Math.random()*8000);
}
setInterval(anomaly,90000);
</script>
</body>
</html>
